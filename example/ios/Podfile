ENV['RCT_NEW_ARCH_ENABLED'] = '1'

# Resolve react_native_pods.rb with node to allow for hoisting
require Pod::Executable.execute_command('node', ['-p',
  'require.resolve(
    "react-native/scripts/react_native_pods.rb",
    {paths: [process.argv[1]]},
  )', __dir__]).strip

platform :ios, min_ios_version_supported
prepare_react_native_project!

linkage = ENV['USE_FRAMEWORKS']
if linkage != nil
  Pod::UI.puts "Configuring Pod with #{linkage}ally linked Frameworks".green
  use_frameworks! :linkage => linkage.to_sym
end

target 'SherpaOnnxSttExample' do
  config = use_native_modules!

  use_react_native!(
    :path => config[:reactNativePath],
    # An absolute path to your application root.
    :app_path => "#{Pod::Config.instance.installation_root}/.."
  )

  post_install do |installer|
    react_native_post_install(
      installer,
      config[:reactNativePath],
      :mac_catalyst_enabled => false,
      # :ccache_enabled => true
    )
    
    # Debug: Find paths for sherpa_onnx XCFramework and SherpaOnnxStt pod
    puts "\n[DEBUG] ========================================"
    puts "[DEBUG] Searching for sherpa_onnx XCFramework and SherpaOnnxStt pod paths..."
    STDERR.puts "\n[DEBUG] ========================================"
    STDERR.puts "[DEBUG] Searching for sherpa_onnx XCFramework and SherpaOnnxStt pod paths..."
    
    # Find SherpaOnnxStt pod installation path
    sherpa_pod_path = nil
    pod_spec = installer.pod_targets.find { |t| t.name == 'SherpaOnnxStt' }
    if pod_spec
      # Use sandbox to get pod directory
      sherpa_pod_path = installer.sandbox.pod_dir('SherpaOnnxStt').to_s
      puts "[DEBUG] SherpaOnnxStt pod path: #{sherpa_pod_path}"
      STDERR.puts "[DEBUG] SherpaOnnxStt pod path: #{sherpa_pod_path}"
      
      # Get PODS_TARGET_SRCROOT relative path
      pods_root = Pod::Config.instance.installation_root
      if File.exist?(sherpa_pod_path)
        relative_path = Pathname.new(sherpa_pod_path).relative_path_from(Pathname.new(pods_root)).to_s
        puts "[DEBUG] PODS_TARGET_SRCROOT would be: #{relative_path}"
        STDERR.puts "[DEBUG] PODS_TARGET_SRCROOT would be: #{relative_path}"
      end
    else
      puts "[DEBUG] SherpaOnnxStt pod target not found"
      STDERR.puts "[DEBUG] SherpaOnnxStt pod target not found"
    end
    
    # Search for XCFramework in various possible locations
    possible_framework_paths = []
    
    # Path 1: Relative to pod root
    if sherpa_pod_path
      possible_framework_paths << File.join(sherpa_pod_path, 'ios', 'Frameworks', 'sherpa_onnx.xcframework')
      possible_framework_paths << File.join(sherpa_pod_path, '..', '..', 'ios', 'Frameworks', 'sherpa_onnx.xcframework')
    end
    
    # Path 2: Relative to Pods root
    pods_root = Pod::Config.instance.installation_root
    possible_framework_paths << File.join(pods_root, '..', '..', 'ios', 'Frameworks', 'sherpa_onnx.xcframework')
    possible_framework_paths << File.join(pods_root, 'SherpaOnnxStt', 'ios', 'Frameworks', 'sherpa_onnx.xcframework')
    
    # Path 3: Absolute path from example directory
    example_root = File.dirname(__dir__)
    possible_framework_paths << File.join(example_root, '..', 'ios', 'Frameworks', 'sherpa_onnx.xcframework')
    
    puts "[DEBUG] Checking possible XCFramework paths:"
    STDERR.puts "[DEBUG] Checking possible XCFramework paths:"
    framework_found_path = nil
    possible_framework_paths.each do |path|
      expanded_path = File.expand_path(path)
      exists = File.exist?(expanded_path)
      status = exists ? "EXISTS" : "NOT FOUND"
      puts "  [#{status}]: #{expanded_path}"
      STDERR.puts "  [#{status}]: #{expanded_path}"
      framework_found_path = expanded_path if exists && framework_found_path.nil?
    end
    
    if framework_found_path
      puts "[DEBUG] XCFramework found at: #{framework_found_path}"
      STDERR.puts "[DEBUG] XCFramework found at: #{framework_found_path}"
    else
      puts "[DEBUG] XCFramework not found in any checked location"
      STDERR.puts "[DEBUG] XCFramework not found in any checked location"
    end
    
    puts "[DEBUG] Pods installation root: #{pods_root}"
    puts "[DEBUG] Example root: #{example_root}"
    STDERR.puts "[DEBUG] Pods installation root: #{pods_root}"
    STDERR.puts "[DEBUG] Example root: #{example_root}"
    puts "[DEBUG] ========================================\n"
    STDERR.puts "[DEBUG] ========================================\n"
    
    # Ensure sherpa_onnx XCFramework is properly linked
    # This is necessary because static libraries in XCFrameworks may not be auto-linked by CocoaPods
    installer.pods_project.targets.each do |target|
      if target.name == 'SherpaOnnxStt'
        target.build_configurations.each do |config|
          # Based on debug output:
          # - PODS_TARGET_SRCROOT is ../.. (relative to Pods root at example/ios)
          # - Framework is at ios/Frameworks/sherpa_onnx.xcframework relative to root
          # - So the path should be $(PODS_TARGET_SRCROOT)/ios/Frameworks
          
          # Add framework search path
          framework_search_paths = config.build_settings['FRAMEWORK_SEARCH_PATHS'] || ['$(inherited)']
          framework_search_paths << '"$(PODS_TARGET_SRCROOT)/ios/Frameworks"'
          config.build_settings['FRAMEWORK_SEARCH_PATHS'] = framework_search_paths.uniq
          
          puts "[DEBUG] Added FRAMEWORK_SEARCH_PATHS: $(PODS_TARGET_SRCROOT)/ios/Frameworks"
          STDERR.puts "[DEBUG] Added FRAMEWORK_SEARCH_PATHS: $(PODS_TARGET_SRCROOT)/ios/Frameworks"
          
          # Force link the framework to ensure all symbols are included
          # For static libraries in XCFrameworks, we need to explicitly link
          other_ldflags = config.build_settings['OTHER_LDFLAGS'] || ['$(inherited)']
          other_ldflags << '-framework sherpa_onnx'
          config.build_settings['OTHER_LDFLAGS'] = other_ldflags.uniq
          
          puts "[DEBUG] Added OTHER_LDFLAGS: -framework sherpa_onnx"
          STDERR.puts "[DEBUG] Added OTHER_LDFLAGS: -framework sherpa_onnx"
        end
      end
    end
  end
end
