name: IOS Turborepo Build
on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup
        uses: ./.github/actions/setup

      - name: Lint files
        run: yarn lint

      - name: Typecheck files
        run: yarn typecheck

  build-ios:
    runs-on: macos-15  # macOS 15 (Sequoia) has Xcode 16.4 with iOS 18.5+ simulator runtimes installed

    env:
      XCODE_VERSION: 16.4
      TURBO_CACHE_DIR: .turbo/ios
      RCT_USE_RN_DEP: 1
      RCT_USE_PREBUILT_RNCORE: 1

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup
        uses: ./.github/actions/setup

      - name: Verify header files exist
        run: |
          echo "Verifying header files exist..."
          if [ ! -f "ios/include/sherpa-onnx/c-api/c-api.h" ]; then
            echo "Error: iOS header files not found at ios/include/sherpa-onnx/c-api/c-api.h"
            echo "Header files should be committed to the repository"
            exit 1
          fi
          echo "✓ Header files found"

      - name: Verify XCFramework exists
        run: |
          if [ ! -d "ios/Frameworks/sherpa_onnx.xcframework" ]; then
            echo "Error: Required XCFramework not found at ios/Frameworks/sherpa_onnx.xcframework"
            echo ""
            echo "The XCFramework is required for iOS builds. Please:"
            echo "1. Run the 'Build sherpa-onnx XCFramework' workflow to build it"
            echo "2. Ensure the workflow commits the framework to the repository"
            echo "3. Or download it from workflow artifacts and place it in ios/Frameworks/"
            exit 1
          fi
          
          echo "✓ XCFramework found"
          echo "Framework structure:"
          ls -la ios/Frameworks/sherpa_onnx.xcframework/
          
          # Verify it contains required architectures
          if [ -d "ios/Frameworks/sherpa_onnx.xcframework/ios-arm64" ]; then
            echo "✓ iOS arm64 architecture found"
          else
            echo "Warning: iOS arm64 architecture not found in framework"
          fi
          
          if [ -d "ios/Frameworks/sherpa_onnx.xcframework/ios-arm64_x86_64-simulator" ]; then
            echo "✓ iOS simulator architecture found"
          else
            echo "Warning: iOS simulator architecture not found in framework"
          fi

      - name: Cache turborepo for iOS
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ${{ env.TURBO_CACHE_DIR }}
          key: ${{ runner.os }}-turborepo-ios-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-turborepo-ios-

      - name: Cache CocoaPods
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        id: cocoapods-cache
        with:
          path: example/ios/Pods
          key: ${{ runner.os }}-cocoapods-${{ hashFiles('example/ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-cocoapods-

      - name: Check turborepo cache for iOS
        run: |
          # Check cache status by running dry-run and parsing JSON output
          yarn turbo run build:ios --cache-dir="${{ env.TURBO_CACHE_DIR }}" --dry=json > /tmp/turbo-dry.json || true
          
          # Extract cache status using node
          TURBO_CACHE_STATUS=$(node -e "const data = require('/tmp/turbo-dry.json'); const task = data.tasks?.find(t => t.task === 'build:ios'); console.log(task?.cache?.status || 'MISS');")
          
          echo "Turborepo cache status: $TURBO_CACHE_STATUS"
          
          if [[ "$TURBO_CACHE_STATUS" == "HIT" ]]; then
            echo "turbo_cache_hit=1" >> $GITHUB_ENV
            echo "✓ Cache hit detected"
          else
            echo "Cache miss - will execute build"
          fi

      - name: Use appropriate Xcode version
        uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1.6.0
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Install CocoaPods dependencies
        if: steps.cocoapods-cache.outputs.cache-hit != 'true'
        run: |
          cd example
          bundle install
          bundle exec pod repo update
          bundle exec pod install --project-directory=ios
          
          echo "Verifying pod installation..."
          # Check if Pods directory exists and contains pods
          if [ ! -d "ios/Pods" ]; then
            echo "Error: Pods directory not found"
            exit 1
          fi
          
          # Check if workspace was created (indicates successful installation)
          if [ ! -f "ios/SherpaOnnxSttExample.xcworkspace/contents.xcworkspacedata" ]; then
            echo "Error: Xcode workspace not created. Pod installation may have failed."
            exit 1
          fi
          
          echo "✓ CocoaPods dependencies installed"

      - name: Verify CocoaPods installation
        run: |
          cd example
          # Verify Pods directory exists (from cache or installation)
          if [ ! -d "ios/Pods" ]; then
            echo "Error: Pods directory not found. CocoaPods installation may have failed."
            exit 1
          fi
          
          # Always run pod install to ensure post_install hook is executed
          # This is critical because the post_install hook modifies build settings
          # for linking the sherpa_onnx XCFramework, which is necessary even if Pods are cached
          echo "Running pod install to ensure post_install hook is executed..."
          bundle install
          bundle exec pod install --project-directory=ios || {
            echo "Error: Failed to run pod install"
            exit 1
          }
          
          # Verify workspace exists
          if [ ! -f "ios/SherpaOnnxSttExample.xcworkspace/contents.xcworkspacedata" ]; then
            echo "Error: Xcode workspace not found after pod install."
            exit 1
          fi
          
          # List installed pods to verify SherpaOnnxStt is included
          echo "Installed pods:"
          ls -la ios/Pods/ | head -20
          
          echo "✓ CocoaPods installation verified"

      - name: Set iOS deployment target to compatible version
        run: |
          cd example/ios
          
          # Use iOS 18.5 as deployment target
          # Xcode 16.4 supports iOS 18.5 SDK and iOS 18.5 simulator runtime is installed on macos-15
          # This matches the installed simulator runtime
          DEPLOYMENT_TARGET="18.5"
          
          echo "Setting iOS deployment target to $DEPLOYMENT_TARGET (compatible with Xcode 16.4)"
          
          # Set IPHONEOS_DEPLOYMENT_TARGET in project.pbxproj
          if [ -f "SherpaOnnxSttExample.xcodeproj/project.pbxproj" ]; then
            # Update deployment target in project file (macOS sed syntax)
            sed -i '' "s/IPHONEOS_DEPLOYMENT_TARGET = [0-9.]*/IPHONEOS_DEPLOYMENT_TARGET = $DEPLOYMENT_TARGET/g" SherpaOnnxSttExample.xcodeproj/project.pbxproj
            echo "✓ Updated iOS deployment target to $DEPLOYMENT_TARGET in project.pbxproj"
          else
            echo "Warning: Could not find project.pbxproj file"
          fi
          
          # Verify the change
          if [ -f "SherpaOnnxSttExample.xcodeproj/project.pbxproj" ]; then
            echo "Verification - deployment targets found:"
            grep "IPHONEOS_DEPLOYMENT_TARGET" SherpaOnnxSttExample.xcodeproj/project.pbxproj | head -5
          fi

      - name: Build example for iOS
        run: |
          set -o pipefail  # Ensure pipe failures are detected
          echo "Building iOS example app..."
          
          # Run build and capture output, preserving exit code
          if ! yarn turbo run build:ios --cache-dir="${{ env.TURBO_CACHE_DIR }}" 2>&1 | tee /tmp/build.log; then
            BUILD_FAILED=1
          fi
          
          if [ "${BUILD_FAILED:-0}" = "1" ]; then
            echo ""
            echo "=== Build failed. Analyzing errors ==="
            
            # Check for linking errors
            if grep -i "undefined symbols\|symbol.*not found\|ld:.*error.*sherpa" /tmp/build.log; then
              echo "❌ Linking errors detected with sherpa-onnx!"
              echo ""
              echo "Relevant error lines:"
              grep -i "undefined symbols\|symbol.*not found\|ld:.*error.*sherpa" /tmp/build.log | head -20
              exit 1
            fi
            
            # Check for iOS platform errors
            if grep -i "iOS.*Platform Not Installed\|platform.*not installed" /tmp/build.log; then
              echo "❌ iOS Platform runtime not installed!"
              echo ""
              echo "This usually means the required iOS simulator runtime is missing."
              echo "Relevant error lines:"
              grep -i "iOS.*Platform Not Installed\|platform.*not installed" /tmp/build.log | head -10
              exit 1
            fi
            
            # Check for compilation errors
            if grep -i "^error:" /tmp/build.log; then
              echo "❌ Compilation errors detected!"
              echo ""
              echo "Relevant error lines:"
              grep -i "^error:" /tmp/build.log | head -30
              exit 1
            fi
            
            # Check for xcodebuild errors
            if grep -i "xcodebuild.*error\|error.*xcodebuild" /tmp/build.log; then
              echo "❌ Xcode build errors detected!"
              echo ""
              echo "Relevant error lines:"
              grep -i "xcodebuild.*error\|error.*xcodebuild" /tmp/build.log | head -20
            fi
            
            # Show all error lines (case-insensitive)
            echo ""
            echo "All error lines found in build log:"
            grep -i "error" /tmp/build.log | grep -v "warning" | head -30
            
            # Generic build failure - show last 150 lines for more context
            echo ""
            echo "❌ Build failed. Showing last 150 lines of build log:"
            tail -150 /tmp/build.log
            exit 1
          fi
          
          echo "✓ iOS build completed successfully"
          echo ""
          echo "Build verification:"
          echo "- TurboModule implementation compiled"
          echo "- XCFramework linked correctly"
          echo "- Example app built successfully"

      - name: Verify TurboModule linking
        run: |
          echo "Verifying TurboModule is properly linked..."
          
          # Check if the built app contains the native module
          if [ -d "example/ios/build" ]; then
            echo "✓ Build artifacts found"
            
            # Try to find symbols related to the TurboModule
            if find example/ios/build -name "*.a" -o -name "*.framework" 2>/dev/null | grep -q "SherpaOnnxStt"; then
              echo "✓ SherpaOnnxStt symbols found in build artifacts"
            else
              echo "Warning: Could not verify SherpaOnnxStt symbols in build artifacts"
            fi
          else
            echo "Warning: Build directory not found (may be cleaned up)"
          fi
