name: Build iOS example app
on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup
        uses: ./.github/actions/setup

      - name: Lint files
        run: yarn lint

      - name: Typecheck files
        run: yarn typecheck

  build-ios:
    runs-on: macos-15
    needs: lint

    env:
      XCODE_VERSION: 16.4

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          lfs: true

      - name: Install Git LFS and pull LFS objects
        run: |
          # Install Git LFS via Homebrew (macOS runner)
          brew install git-lfs

          # Initialize Git LFS
          git lfs install

          # Pull LFS objects (this replaces pointer files with actual content)
          echo "Pulling Git LFS objects..."
          git lfs pull

          # Verify LFS objects were pulled
          echo ""
          echo "Verifying LFS objects:"
          git lfs ls-files | head -5 || echo "No LFS files tracked"

          # Check if the library files are actual files (not pointers)
          for arch in ios-arm64 ios-arm64_x86_64-simulator; do
            lib="ios/Frameworks/sherpa_onnx.xcframework/$arch/libsherpa-onnx.a"
            if [ -f "$lib" ]; then
              size_bytes=$(stat -f%z "$lib" 2>/dev/null || stat -c%s "$lib")
              size_human=$(ls -lh "$lib" | awk '{print $5}')
              echo "  $arch: $size_human ($size_bytes bytes)"
              
              # If file is < 1KB, it's likely still a pointer file
              if [ "$size_bytes" -lt 1024 ]; then
                echo "  [WARNING] File appears to be a pointer file, not actual content!"
              fi
            fi
          done

      - name: Setup
        uses: ./.github/actions/setup

      - name: Verify required files exist
        run: |
          echo "Verifying required files..."

          # Check header files
          if [ ! -f "ios/include/sherpa-onnx/c-api/c-api.h" ]; then
            echo "Error: iOS header files not found at ios/include/sherpa-onnx/c-api/c-api.h"
            exit 1
          fi
          echo "[OK] Header files found"

          # Check XCFramework
          if [ ! -d "ios/Frameworks/sherpa_onnx.xcframework" ]; then
            echo "Error: XCFramework not found at ios/Frameworks/sherpa_onnx.xcframework"
            exit 1
          fi
          echo "[OK] XCFramework found"

          # Check xcconfig file
          if [ ! -f "ios/SherpaOnnxStt.xcconfig" ]; then
            echo "Error: xcconfig not found at ios/SherpaOnnxStt.xcconfig"
            exit 1
          fi
          echo "[OK] xcconfig found"

          # Verify XCFramework structure
          echo ""
          echo "XCFramework structure:"
          ls -la ios/Frameworks/sherpa_onnx.xcframework/

          echo ""
          echo "Verifying architecture slices:"
          MIN_SIZE=52428800  # 50MB - libraries with ONNX Runtime should be >50MB

          for arch in ios-arm64 ios-arm64_x86_64-simulator; do
            lib="ios/Frameworks/sherpa_onnx.xcframework/$arch/libsherpa-onnx.a"
            if [ -f "$lib" ]; then
              size_human=$(ls -lh "$lib" | awk '{print $5}')
              size_bytes=$(stat -f%z "$lib" 2>/dev/null || stat -c%s "$lib")
              echo "[OK] $arch/libsherpa-onnx.a ($size_human, $size_bytes bytes)"
              
              # Check if library is large enough (should include ONNX Runtime)
              if [ "$size_bytes" -lt "$MIN_SIZE" ]; then
                echo "[ERROR] Library is too small! ONNX Runtime is NOT included."
                echo "        Expected: >50MB, Got: $size_human"
                echo "        Please run the build-sherpa-onnx-framework workflow to rebuild with ONNX Runtime."
                exit 1
              fi
              
              # Verify architectures in the static library using lipo
              echo "    Architectures: $(lipo -archs "$lib" 2>/dev/null || echo 'unable to determine')"
            else
              echo "[ERROR] $arch/libsherpa-onnx.a NOT FOUND"
              exit 1
            fi
          done

          # Specifically check that simulator library has x86_64
          echo ""
          echo "Verifying x86_64 support in simulator library:"
          SIM_LIB="ios/Frameworks/sherpa_onnx.xcframework/ios-arm64_x86_64-simulator/libsherpa-onnx.a"
          ARCHS=$(lipo -archs "$SIM_LIB" 2>/dev/null)
          echo "  Architectures in simulator lib: $ARCHS"
          if [[ "$ARCHS" != *"x86_64"* ]]; then
            echo "[ERROR] x86_64 architecture NOT found in simulator library!"
            echo "        This will cause linker errors on Intel Macs and x86_64 simulators."
            exit 1
          fi
          echo "[OK] x86_64 architecture confirmed"

          # Check for key sherpa-onnx symbols in the library
          echo ""
          echo "Checking for key sherpa-onnx symbols in library:"

          # Check arm64 slice first
          echo "=== arm64 slice ==="
          lipo -extract arm64 "$SIM_LIB" -output /tmp/libsherpa-arm64.a 2>/dev/null || true
          if [ -f /tmp/libsherpa-arm64.a ]; then
            arm64_symbols=$(nm /tmp/libsherpa-arm64.a 2>/dev/null | grep -c "OfflineRecognizer" || echo "0")
            echo "  OfflineRecognizer symbol count: $arm64_symbols"
            if [ "$arm64_symbols" -gt "0" ]; then
              echo "[OK] OfflineRecognizer symbols found in arm64 slice"
            else
              echo "[WARNING] OfflineRecognizer symbols NOT found in arm64 slice"
            fi
            rm /tmp/libsherpa-arm64.a
          fi

          # Check x86_64 slice
          echo "=== x86_64 slice ==="
          lipo -extract x86_64 "$SIM_LIB" -output /tmp/libsherpa-x86_64.a 2>/dev/null || true
          if [ -f /tmp/libsherpa-x86_64.a ]; then
            x86_symbols=$(nm /tmp/libsherpa-x86_64.a 2>/dev/null | grep -c "OfflineRecognizer" || echo "0")
            echo "  OfflineRecognizer symbol count: $x86_symbols"
            if [ "$x86_symbols" -gt "0" ]; then
              echo "[OK] OfflineRecognizer symbols found in x86_64 slice"
            else
              echo "[ERROR] OfflineRecognizer symbols NOT found in x86_64 slice!"
              echo "  This indicates the library was not built correctly for x86_64"
              echo ""
              echo "Sample symbols in x86_64 slice:"
              nm /tmp/libsherpa-x86_64.a 2>/dev/null | grep "sherpa_onnx" | head -20 || echo "  No sherpa_onnx symbols found"
            fi
            rm /tmp/libsherpa-x86_64.a
          else
            echo "[WARNING] Could not extract x86_64 slice for symbol check"
          fi

          # Also check device library arm64
          echo ""
          echo "=== Device library (ios-arm64) ==="
          DEVICE_LIB="ios/Frameworks/sherpa_onnx.xcframework/ios-arm64/libsherpa-onnx.a"
          device_symbols=$(nm "$DEVICE_LIB" 2>/dev/null | grep -c "OfflineRecognizer" || echo "0")
          echo "  OfflineRecognizer symbol count: $device_symbols"
          if [ "$device_symbols" -gt "0" ]; then
            echo "[OK] OfflineRecognizer symbols found in device library"
          else
            echo "[WARNING] OfflineRecognizer symbols NOT found in device library"
          fi

      - name: Use appropriate Xcode version
        uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1.6.0
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Install CocoaPods dependencies
        run: |
          cd example
          bundle install

          echo "Running pod install (vendored_frameworks handles XCFramework linking automatically)..."
          echo ""

          # Run pod install and capture output to show post_install messages
          bundle exec pod install --project-directory=ios 2>&1 | tee /tmp/pod_install.log

          echo ""
          echo "=== Filtering SherpaOnnxStt messages from pod install ==="
          grep -E "\[SherpaOnnxStt\]" /tmp/pod_install.log || echo "No SherpaOnnxStt messages found in pod install output"

          # Verify installation
          if [ ! -f "ios/SherpaOnnxSttExample.xcworkspace/contents.xcworkspacedata" ]; then
            echo "Error: Xcode workspace not created"
            exit 1
          fi

          echo ""
          echo "[OK] CocoaPods dependencies installed"

      - name: Verify xcconfig is applied
        run: |
          echo "=== Checking Pod Target xcconfig ==="
          PODS_XCCONFIG="example/ios/Pods/Target Support Files/SherpaOnnxStt/SherpaOnnxStt.debug.xcconfig"
          if [ -f "$PODS_XCCONFIG" ]; then
            echo "Pod xcconfig found. Checking key settings..."
            
            if grep -q "HEADER_SEARCH_PATHS" "$PODS_XCCONFIG"; then
              echo "[OK] HEADER_SEARCH_PATHS found"
            fi
            
            if grep -q "LIBRARY_SEARCH_PATHS" "$PODS_XCCONFIG"; then
              echo "[OK] LIBRARY_SEARCH_PATHS found in pod xcconfig"
              grep "LIBRARY_SEARCH_PATHS" "$PODS_XCCONFIG"
            else
              echo "[WARNING] LIBRARY_SEARCH_PATHS not found in pod xcconfig"
            fi
          fi

          echo ""
          echo "=== Checking App Target xcconfig (vendored_frameworks handles linking automatically) ==="
          # The aggregated settings for the app are in Pods-SherpaOnnxSttExample
          APP_XCCONFIG="example/ios/Pods/Target Support Files/Pods-SherpaOnnxSttExample/Pods-SherpaOnnxSttExample.debug.xcconfig"
          if [ -f "$APP_XCCONFIG" ]; then
            echo "App xcconfig found at: $APP_XCCONFIG"
            echo ""
            
            # Show the last 15 lines
            echo "Last 15 lines of xcconfig:"
            tail -15 "$APP_XCCONFIG"
            echo ""
            
            # Check for FRAMEWORK_SEARCH_PATHS containing sherpa_onnx (vendored_frameworks adds this)
            echo "Checking for XCFramework linking configuration:"
            if grep -q "sherpa_onnx" "$APP_XCCONFIG"; then
              echo "[OK] sherpa_onnx framework referenced in app xcconfig"
              grep "sherpa_onnx" "$APP_XCCONFIG" | head -3
            else
              echo "[WARNING] sherpa_onnx framework not directly referenced in xcconfig"
              echo "Note: vendored_frameworks may handle linking automatically via OTHER_LDFLAGS"
            fi
            
            # Check FRAMEWORK_SEARCH_PATHS
            if grep -q "FRAMEWORK_SEARCH_PATHS.*sherpa" "$APP_XCCONFIG"; then
              echo "[OK] FRAMEWORK_SEARCH_PATHS contains sherpa_onnx path"
            else
              echo "[INFO] FRAMEWORK_SEARCH_PATHS check (vendored_frameworks may handle this differently)"
            fi
            
            # Note: force_load is no longer needed - vendored_frameworks handles linking automatically
            if grep -q "force_load" "$APP_XCCONFIG"; then
              echo "[INFO] force_load found (may be from other pods or legacy config)"
              grep "force_load" "$APP_XCCONFIG" | head -3
            else
              echo "[OK] force_load not found (expected - vendored_frameworks handles linking automatically)"
            fi
          else
            echo "Error: App xcconfig not found at expected path"
            echo "Available xcconfig files:"
            find example/ios/Pods -name "*.xcconfig" -type f | head -20
            exit 1
          fi

          echo ""
          echo "=== Verifying header file locations ==="
          if [ -f "ios/include/sherpa-onnx/c-api/cxx-api.h" ]; then
            echo "[OK] Header files exist"
          else
            echo "[ERROR] Header files missing!"
          fi

      - name: Show resolved Xcode build settings
        run: |
          echo "=== Checking Xcode resolved build settings for OTHER_LDFLAGS ==="
          cd example

          # List available simulators first
          echo "Available simulators:"
          xcrun simctl list devices available | grep -E "iPhone|iPad" | head -10 || true

          # Show the resolved OTHER_LDFLAGS for the app target on simulator
          # Use generic destination to avoid simulator availability issues
          echo ""
          echo "Resolved OTHER_LDFLAGS for Debug-iphonesimulator:"
          xcodebuild -workspace ios/SherpaOnnxSttExample.xcworkspace \
            -scheme SherpaOnnxSttExample \
            -configuration Debug \
            -sdk iphonesimulator \
            -showBuildSettings 2>&1 | grep -A2 "OTHER_LDFLAGS" | head -20 || echo "Could not get build settings"

          echo ""
          echo "Checking if sherpa_onnx framework is linked (vendored_frameworks handles this):"
          SETTINGS=$(xcodebuild -workspace ios/SherpaOnnxSttExample.xcworkspace \
            -scheme SherpaOnnxSttExample \
            -configuration Debug \
            -sdk iphonesimulator \
            -showBuildSettings 2>&1) || true

          if echo "$SETTINGS" | grep -q "sherpa_onnx"; then
            echo "[OK] sherpa_onnx framework found in resolved build settings"
            echo "$SETTINGS" | grep "sherpa_onnx" | head -5
          else
            echo "[INFO] sherpa_onnx not found in resolved settings (vendored_frameworks may handle linking differently)"
          fi

          # Check for force_load (may be from other pods, but not required for sherpa_onnx)
          if echo "$SETTINGS" | grep -q "force_load"; then
            echo "[INFO] force_load found in resolved build settings (may be from other pods)"
            echo "$SETTINGS" | grep "force_load" | head -5
          else
            echo "[OK] force_load not found (expected - vendored_frameworks handles sherpa_onnx linking automatically)"
          fi

          echo ""
          echo "All OTHER_LDFLAGS entries:"
          echo "$SETTINGS" | grep "OTHER_LDFLAGS" | head -10 || echo "No OTHER_LDFLAGS found"

          echo ""
          echo "FRAMEWORK_SEARCH_PATHS:"
          echo "$SETTINGS" | grep "FRAMEWORK_SEARCH_PATHS" | head -5 || echo "No FRAMEWORK_SEARCH_PATHS found"

          echo ""
          echo "LIBRARY_SEARCH_PATHS:"
          echo "$SETTINGS" | grep "LIBRARY_SEARCH_PATHS" | head -5 || echo "No LIBRARY_SEARCH_PATHS found"

          # Check the Xcode project file directly for build settings
          echo ""
          echo "=== Checking Xcode project for framework linking ==="
          if grep -q "sherpa_onnx" "ios/SherpaOnnxSttExample.xcodeproj/project.pbxproj"; then
            echo "[OK] sherpa_onnx framework found in Xcode project file"
            grep "sherpa_onnx" "ios/SherpaOnnxSttExample.xcodeproj/project.pbxproj" | head -5
          else
            echo "[INFO] sherpa_onnx not found directly in Xcode project file"
            echo "This is expected - vendored_frameworks handles linking via CocoaPods"
          fi

          # Note about force_load
          if grep -q "force_load" "ios/SherpaOnnxSttExample.xcodeproj/project.pbxproj"; then
            echo "[INFO] force_load found in Xcode project file (may be from other pods)"
            grep "force_load" "ios/SherpaOnnxSttExample.xcodeproj/project.pbxproj" | head -5
          else
            echo "[OK] force_load not found directly in Xcode project file (expected for sherpa_onnx)"
          fi
        continue-on-error: true

      - name: Build example for iOS
        run: |
          set -o pipefail
          echo "Building iOS example app for simulator..."

          cd example

          # Build for simulator using -sdk flag (more reliable than -destination)
          # This builds for the current architecture of the Mac runner
          if ! xcodebuild \
            -workspace ios/SherpaOnnxSttExample.xcworkspace \
            -scheme SherpaOnnxSttExample \
            -configuration Debug \
            -sdk iphonesimulator \
            -arch arm64 \
            -derivedDataPath ios/build \
            CODE_SIGNING_ALLOWED=NO \
            > /tmp/build.full.log 2>&1; then
            BUILD_FAILED=1
          fi

          # Display filtered output (errors, warnings, important messages)
          echo "=== Filtered Build Output ==="
          grep -E "(: error:|: warning:|BUILD SUCCEEDED|BUILD FAILED|Undefined symbols|fatal error)" /tmp/build.full.log | head -100 || true

          if [ "${BUILD_FAILED:-0}" = "1" ]; then
            echo ""
            echo "=== Build failed. Full error analysis ==="
            
            # Show all lines containing "error:" with context
            echo ""
            echo "--- Compilation/Linker Errors ---"
            grep -B 2 -A 5 ": error:" /tmp/build.full.log | head -100 || echo "No 'error:' lines found"
            
            # Show fatal errors
            echo ""
            echo "--- Fatal Errors ---"
            grep -B 2 -A 5 "fatal error" /tmp/build.full.log | head -50 || echo "No fatal errors found"
            
            # Check for undefined symbols (linking)
            echo ""
            echo "--- Undefined Symbols ---"
            grep -B 2 -A 10 "Undefined symbols" /tmp/build.full.log | head -50 || echo "No undefined symbols"
            
            # Show the CompileC failure details
            echo ""
            echo "--- Failed Commands ---"
            grep -B 5 -A 2 "following build commands failed" /tmp/build.full.log | head -30 || true
            
            # Last part of log for context
            echo ""
            echo "--- Last 50 lines of build log ---"
            tail -50 /tmp/build.full.log
            exit 1
          fi

          echo "[OK] iOS build completed successfully"

      - name: Verify build artifacts
        run: |
          echo "Verifying build artifacts..."

          if [ -d "example/ios/build" ]; then
            echo "[OK] Build directory exists"
            
            # Check for the app
            APP_PATH=$(find example/ios/build -name "*.app" -type d | head -1)
            if [ -n "$APP_PATH" ]; then
              echo "[OK] App bundle found: $APP_PATH"
            else
              echo "Warning: App bundle not found in build directory"
            fi
          else
            echo "Warning: Build directory not found"
          fi

      - name: Create iOS IPA file
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          echo "Creating iOS IPA file..."
          
          # Find the app bundle
          APP_PATH=$(find example/ios/build -name "*.app" -type d | head -1)
          
          if [ -z "$APP_PATH" ]; then
            echo "Error: App bundle not found"
            exit 1
          fi
          
          echo "Found app bundle: $APP_PATH"
          
          # Create IPA structure
          IPA_DIR="example/ios/build/ipa"
          PAYLOAD_DIR="$IPA_DIR/Payload"
          
          mkdir -p "$PAYLOAD_DIR"
          
          # Copy app bundle to Payload directory
          cp -R "$APP_PATH" "$PAYLOAD_DIR/"
          
          # Create IPA file (ZIP archive)
          IPA_NAME="SherpaOnnxSttExample.ipa"
          IPA_PATH="$IPA_DIR/$IPA_NAME"
          
          cd "$IPA_DIR"
          zip -r "$IPA_NAME" Payload
          cd - > /dev/null
          
          if [ -f "$IPA_PATH" ]; then
            IPA_SIZE=$(stat -f%z "$IPA_PATH" 2>/dev/null || stat -c%s "$IPA_PATH")
            IPA_SIZE_MB=$((IPA_SIZE / 1024 / 1024))
            echo "[OK] IPA file created: $IPA_PATH (${IPA_SIZE_MB}MB)"
          else
            echo "Error: IPA file was not created at $IPA_PATH"
            echo "Checking for IPA files in build directory:"
            find example/ios/build -name "*.ipa" -type f || echo "No IPA files found"
            exit 1
          fi

      - name: Upload iOS IPA artifact
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-bundle
          path: example/ios/build/ipa/*.ipa
          retention-days: 7
          if-no-files-found: error
