name: IOS Turborepo Build
on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup
        uses: ./.github/actions/setup

      - name: Lint files
        run: yarn lint

      - name: Typecheck files
        run: yarn typecheck

  build-ios:
    runs-on: macos-15

    env:
      XCODE_VERSION: 16.4

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup
        uses: ./.github/actions/setup

      - name: Verify required files exist
        run: |
          echo "Verifying required files..."
          
          # Check header files
          if [ ! -f "ios/include/sherpa-onnx/c-api/c-api.h" ]; then
            echo "Error: iOS header files not found at ios/include/sherpa-onnx/c-api/c-api.h"
            exit 1
          fi
          echo "[OK] Header files found"
          
          # Check XCFramework
          if [ ! -d "ios/Frameworks/sherpa_onnx.xcframework" ]; then
            echo "Error: XCFramework not found at ios/Frameworks/sherpa_onnx.xcframework"
            exit 1
          fi
          echo "[OK] XCFramework found"
          
          # Check xcconfig file
          if [ ! -f "ios/SherpaOnnxStt.xcconfig" ]; then
            echo "Error: xcconfig not found at ios/SherpaOnnxStt.xcconfig"
            exit 1
          fi
          echo "[OK] xcconfig found"
          
          # Verify XCFramework structure
          echo ""
          echo "XCFramework structure:"
          ls -la ios/Frameworks/sherpa_onnx.xcframework/
          
          echo ""
          echo "Verifying architecture slices:"
          for arch in ios-arm64 ios-arm64_x86_64-simulator; do
            lib="ios/Frameworks/sherpa_onnx.xcframework/$arch/libsherpa-onnx.a"
            if [ -f "$lib" ]; then
              size=$(ls -lh "$lib" | awk '{print $5}')
              echo "[OK] $arch/libsherpa-onnx.a ($size)"
            else
              echo "[ERROR] $arch/libsherpa-onnx.a NOT FOUND"
            fi
          done

      - name: Use appropriate Xcode version
        uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1.6.0
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Install CocoaPods dependencies
        run: |
          cd example
          bundle install
          bundle exec pod install --project-directory=ios
          
          # Verify installation
          if [ ! -f "ios/SherpaOnnxSttExample.xcworkspace/contents.xcworkspacedata" ]; then
            echo "Error: Xcode workspace not created"
            exit 1
          fi
          
          echo "[OK] CocoaPods dependencies installed"

      - name: Verify xcconfig is applied
        run: |
          echo "Checking if xcconfig settings are in the Pods project..."
          
          PODS_XCCONFIG="example/ios/Pods/Target Support Files/SherpaOnnxStt/SherpaOnnxStt.debug.xcconfig"
          if [ -f "$PODS_XCCONFIG" ]; then
            echo "=== Contents of SherpaOnnxStt.debug.xcconfig ==="
            cat "$PODS_XCCONFIG"
            echo ""
            echo "=== End of xcconfig ==="
            echo ""
            
            # Check for HEADER_SEARCH_PATHS
            if grep -q "HEADER_SEARCH_PATHS" "$PODS_XCCONFIG"; then
              echo "[OK] HEADER_SEARCH_PATHS found in xcconfig"
              grep "HEADER_SEARCH_PATHS" "$PODS_XCCONFIG"
            else
              echo "[ERROR] HEADER_SEARCH_PATHS not found in xcconfig!"
            fi
            
            # Check for our conditional settings
            if grep -q "SHERPA_ONNX_LIB_DIR" "$PODS_XCCONFIG"; then
              echo "[OK] SHERPA_ONNX_LIB_DIR found in xcconfig"
            else
              echo "[WARNING] SHERPA_ONNX_LIB_DIR not found"
            fi
            
            if grep -q "force_load" "$PODS_XCCONFIG"; then
              echo "[OK] force_load found in xcconfig"
            else
              echo "[WARNING] force_load not found in xcconfig"
            fi
          else
            echo "Error: Could not find xcconfig file at: $PODS_XCCONFIG"
            echo "Available files in Target Support Files:"
            ls -la "example/ios/Pods/Target Support Files/" || true
          fi
          
          echo ""
          echo "=== Checking PODS_TARGET_SRCROOT resolution ==="
          # Find the PODS_TARGET_SRCROOT in Pods.xcodeproj
          PODS_PROJECT="example/ios/Pods/Pods.xcodeproj/project.pbxproj"
          if [ -f "$PODS_PROJECT" ]; then
            echo "Looking for SherpaOnnxStt PODS_TARGET_SRCROOT in Pods project..."
            grep -A 2 "PODS_TARGET_SRCROOT.*SherpaOnnxStt" "$PODS_PROJECT" | head -10 || echo "Not found directly"
            grep "SherpaOnnxStt" "$PODS_PROJECT" | grep -i "srcroot\|path" | head -5 || true
          fi
          
          echo ""
          echo "=== Verifying header file locations ==="
          echo "Headers should be at: ios/include/sherpa-onnx/c-api/"
          ls -la ios/include/sherpa-onnx/c-api/ || echo "Directory not found!"
          
          echo ""
          echo "Full header path for compiler:"
          FULL_PATH=$(pwd)/ios/include
          echo "Expected HEADER_SEARCH_PATHS base: $FULL_PATH"
          echo "Looking for: sherpa-onnx/c-api/cxx-api.h"
          if [ -f "$FULL_PATH/sherpa-onnx/c-api/cxx-api.h" ]; then
            echo "[OK] Header file exists at: $FULL_PATH/sherpa-onnx/c-api/cxx-api.h"
          else
            echo "[ERROR] Header file NOT found at: $FULL_PATH/sherpa-onnx/c-api/cxx-api.h"
          fi

      - name: Build example for iOS
        run: |
          set -o pipefail
          echo "Building iOS example app for simulator..."
          
          cd example
          
          # Build and save full log to file
          if ! xcodebuild \
            -workspace ios/SherpaOnnxSttExample.xcworkspace \
            -scheme SherpaOnnxSttExample \
            -configuration Debug \
            -destination 'generic/platform=iOS Simulator' \
            -derivedDataPath ios/build \
            CODE_SIGNING_ALLOWED=NO \
            > /tmp/build.full.log 2>&1; then
            BUILD_FAILED=1
          fi
          
          # Display filtered output (errors, warnings, important messages)
          echo "=== Filtered Build Output ==="
          grep -E "(: error:|: warning:|BUILD SUCCEEDED|BUILD FAILED|Undefined symbols|fatal error)" /tmp/build.full.log | head -100 || true
          
          if [ "${BUILD_FAILED:-0}" = "1" ]; then
            echo ""
            echo "=== Build failed. Full error analysis ==="
            
            # Show all lines containing "error:" with context
            echo ""
            echo "--- Compilation/Linker Errors ---"
            grep -B 2 -A 5 ": error:" /tmp/build.full.log | head -100 || echo "No 'error:' lines found"
            
            # Show fatal errors
            echo ""
            echo "--- Fatal Errors ---"
            grep -B 2 -A 5 "fatal error" /tmp/build.full.log | head -50 || echo "No fatal errors found"
            
            # Check for undefined symbols (linking)
            echo ""
            echo "--- Undefined Symbols ---"
            grep -B 2 -A 10 "Undefined symbols" /tmp/build.full.log | head -50 || echo "No undefined symbols"
            
            # Show the CompileC failure details
            echo ""
            echo "--- Failed Commands ---"
            grep -B 5 -A 2 "following build commands failed" /tmp/build.full.log | head -30 || true
            
            # Last part of log for context
            echo ""
            echo "--- Last 50 lines of build log ---"
            tail -50 /tmp/build.full.log
            exit 1
          fi
          
          echo "[OK] iOS build completed successfully"

      - name: Verify build artifacts
        run: |
          echo "Verifying build artifacts..."
          
          if [ -d "example/ios/build" ]; then
            echo "[OK] Build directory exists"
            
            # Check for the app
            APP_PATH=$(find example/ios/build -name "*.app" -type d | head -1)
            if [ -n "$APP_PATH" ]; then
              echo "[OK] App bundle found: $APP_PATH"
            else
              echo "Warning: App bundle not found in build directory"
            fi
          else
            echo "Warning: Build directory not found"
          fi
