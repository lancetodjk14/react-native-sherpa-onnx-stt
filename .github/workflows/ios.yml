name: IOS Turborepo Build
on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup
        uses: ./.github/actions/setup

      - name: Lint files
        run: yarn lint

      - name: Typecheck files
        run: yarn typecheck

  build-ios:
    runs-on: macos-latest

    env:
      XCODE_VERSION: 16.3
      TURBO_CACHE_DIR: .turbo/ios
      RCT_USE_RN_DEP: 1
      RCT_USE_PREBUILT_RNCORE: 1

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup
        uses: ./.github/actions/setup

      - name: Verify header files exist
        run: |
          echo "Verifying header files exist..."
          if [ ! -f "ios/include/sherpa-onnx/c-api/c-api.h" ]; then
            echo "Error: iOS header files not found at ios/include/sherpa-onnx/c-api/c-api.h"
            echo "Header files should be committed to the repository"
            exit 1
          fi
          echo "✓ Header files found"

      - name: Verify XCFramework exists
        run: |
          if [ ! -d "ios/Frameworks/sherpa_onnx.xcframework" ]; then
            echo "Error: Required XCFramework not found at ios/Frameworks/sherpa_onnx.xcframework"
            echo ""
            echo "The XCFramework is required for iOS builds. Please:"
            echo "1. Run the 'Build sherpa-onnx XCFramework' workflow to build it"
            echo "2. Ensure the workflow commits the framework to the repository"
            echo "3. Or download it from workflow artifacts and place it in ios/Frameworks/"
            exit 1
          fi
          
          echo "✓ XCFramework found"
          echo "Framework structure:"
          ls -la ios/Frameworks/sherpa_onnx.xcframework/
          
          # Verify it contains required architectures
          if [ -d "ios/Frameworks/sherpa_onnx.xcframework/ios-arm64" ]; then
            echo "✓ iOS arm64 architecture found"
          else
            echo "Warning: iOS arm64 architecture not found in framework"
          fi
          
          if [ -d "ios/Frameworks/sherpa_onnx.xcframework/ios-arm64_x86_64-simulator" ]; then
            echo "✓ iOS simulator architecture found"
          else
            echo "Warning: iOS simulator architecture not found in framework"
          fi

      - name: Cache turborepo for iOS
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ${{ env.TURBO_CACHE_DIR }}
          key: ${{ runner.os }}-turborepo-ios-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-turborepo-ios-

      - name: Cache CocoaPods
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        id: cocoapods-cache
        with:
          path: example/ios/Pods
          key: ${{ runner.os }}-cocoapods-${{ hashFiles('example/ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-cocoapods-

      - name: Check turborepo cache for iOS
        run: |
          TURBO_CACHE_STATUS=$(node -p "($(yarn turbo run build:ios --cache-dir="${{ env.TURBO_CACHE_DIR }}" --dry=json)).tasks.find(t => t.task === 'build:ios').cache.status")
          
          if [[ $TURBO_CACHE_STATUS == "HIT" ]]; then
            echo "turbo_cache_hit=1" >> $GITHUB_ENV
          fi

      - name: Use appropriate Xcode version
        if: env.turbo_cache_hit != 1
        uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1.6.0
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Install CocoaPods dependencies
        if: env.turbo_cache_hit != 1 && steps.cocoapods-cache.outputs.cache-hit != 'true'
        run: |
          cd example
          bundle install
          bundle exec pod repo update
          bundle exec pod install --project-directory=ios
          
          echo "Verifying pod installation..."
          if [ ! -d "ios/Pods/SherpaOnnxStt" ]; then
            echo "Error: SherpaOnnxStt pod not installed"
            exit 1
          fi
          echo "✓ CocoaPods dependencies installed"

      - name: Build example for iOS
        run: |
          echo "Building iOS example app..."
          yarn turbo run build:ios --cache-dir="${{ env.TURBO_CACHE_DIR }}"
          
          echo "✓ iOS build completed successfully"
          echo ""
          echo "Build verification:"
          echo "- TurboModule implementation compiled"
          echo "- XCFramework linked correctly"
          echo "- Example app built successfully"

      - name: Verify TurboModule linking
        run: |
          echo "Verifying TurboModule is properly linked..."
          
          # Check if the built app contains the native module
          if [ -d "example/ios/build" ]; then
            echo "✓ Build artifacts found"
            
            # Try to find symbols related to the TurboModule
            if find example/ios/build -name "*.a" -o -name "*.framework" 2>/dev/null | grep -q "SherpaOnnxStt"; then
              echo "✓ SherpaOnnxStt symbols found in build artifacts"
            else
              echo "Warning: Could not verify SherpaOnnxStt symbols in build artifacts"
            fi
          else
            echo "Warning: Build directory not found (may be cleaned up)"
          fi
