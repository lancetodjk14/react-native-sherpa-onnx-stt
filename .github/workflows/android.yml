name: Build Android example app
on:
  push:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup
        uses: ./.github/actions/setup

      - name: Lint files
        run: yarn lint

      - name: Typecheck files
        run: yarn typecheck

  build-android:
    runs-on: ubuntu-latest
    needs: lint

    env:
      JAVA_VERSION: '17'

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          lfs: true

      - name: Install Git LFS and pull LFS objects
        run: |
          # Install Git LFS
          sudo apt-get update
          sudo apt-get install -y git-lfs
          
          # Initialize Git LFS
          git lfs install
          
          # Pull LFS objects (this replaces pointer files with actual content)
          echo "Pulling Git LFS objects..."
          git lfs pull
          
          # Verify LFS objects were pulled
          echo ""
          echo "Verifying LFS objects:"
          git lfs ls-files | head -5 || echo "No LFS files tracked"

      - name: Setup
        uses: ./.github/actions/setup

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Copy header files
        run: |
          echo "Copying header files..."
          yarn copy-headers || echo "Warning: copy-headers failed, checking if headers already exist..."
          
          # Verify headers were copied or already exist
          if [ ! -f "android/src/main/cpp/include/sherpa-onnx/c-api/c-api.h" ]; then
            echo "Error: Android header files not found at android/src/main/cpp/include/sherpa-onnx/c-api/c-api.h"
            echo "Please ensure the git submodule is initialized or headers are copied."
            exit 1
          fi
          echo "[OK] Header files found"

      - name: Verify required files exist
        run: |
          echo "Verifying required files..."
          
          # Check header files (already verified in previous step, but double-check)
          if [ ! -f "android/src/main/cpp/include/sherpa-onnx/c-api/c-api.h" ]; then
            echo "Error: Android header files not found at android/src/main/cpp/include/sherpa-onnx/c-api/c-api.h"
            exit 1
          fi
          echo "[OK] Header files found"
          
          # Check CMakeLists.txt
          if [ ! -f "android/src/main/cpp/CMakeLists.txt" ]; then
            echo "Error: CMakeLists.txt not found at android/src/main/cpp/CMakeLists.txt"
            exit 1
          fi
          echo "[OK] CMakeLists.txt found"
          
          # Check Android build.gradle files
          if [ ! -f "android/build.gradle" ]; then
            echo "Error: android/build.gradle not found"
            exit 1
          fi
          echo "[OK] android/build.gradle found"
          
          if [ ! -f "example/android/build.gradle" ]; then
            echo "Error: example/android/build.gradle not found"
            exit 1
          fi
          echo "[OK] example/android/build.gradle found"
          
          if [ ! -f "example/android/app/build.gradle" ]; then
            echo "Error: example/android/app/build.gradle not found"
            exit 1
          fi
          echo "[OK] example/android/app/build.gradle found"
          
          # Check native source files
          if [ ! -f "android/src/main/cpp/jni/sherpa-onnx-stt-jni.cpp" ]; then
            echo "Error: JNI source file not found"
            exit 1
          fi
          echo "[OK] JNI source files found"
          
          # Verify header file structure
          echo ""
          echo "Header file structure:"
          find android/src/main/cpp/include -name "*.h" -type f | head -10 || echo "No header files found"

      - name: Make gradlew executable
        run: |
          cd example/android
          chmod +x gradlew
          chmod +x gradlew.bat

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            example/android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build Android example app
        run: |
          set -o pipefail
          echo "Building Android example app..."
          
          cd example/android
          
          # Clean previous builds
          ./gradlew clean
          
          # Build debug APK
          if ! ./gradlew assembleDebug \
            --stacktrace \
            --info \
            > /tmp/build.full.log 2>&1; then
            BUILD_FAILED=1
          fi
          
          # Display filtered output (errors, warnings, important messages)
          echo "=== Filtered Build Output ==="
          grep -E "(FAILED|ERROR|error:|warning:|BUILD SUCCEEDED|BUILD FAILED|FAILURE|Exception)" /tmp/build.full.log | head -100 || true
          
          if [ "${BUILD_FAILED:-0}" = "1" ]; then
            echo ""
            echo "=== Build failed. Full error analysis ==="
            
            # Show all lines containing "error:" or "ERROR" with context
            echo ""
            echo "--- Compilation/Linker Errors ---"
            grep -B 2 -A 5 -i "error:" /tmp/build.full.log | head -100 || echo "No 'error:' lines found"
            
            # Show fatal errors
            echo ""
            echo "--- Fatal Errors ---"
            grep -B 2 -A 5 -i "fatal" /tmp/build.full.log | head -50 || echo "No fatal errors found"
            
            # Show exceptions
            echo ""
            echo "--- Exceptions ---"
            grep -B 2 -A 10 "Exception" /tmp/build.full.log | head -50 || echo "No exceptions found"
            
            # Show CMake errors if any
            echo ""
            echo "--- CMake Errors ---"
            grep -B 2 -A 5 -i "cmake" /tmp/build.full.log | grep -i "error\|fail" | head -30 || echo "No CMake errors found"
            
            # Show the Gradle failure details
            echo ""
            echo "--- Failed Tasks ---"
            grep -B 5 -A 2 "FAILED" /tmp/build.full.log | head -30 || true
            
            # Last part of log for context
            echo ""
            echo "--- Last 50 lines of build log ---"
            tail -50 /tmp/build.full.log
            exit 1
          fi
          
          echo "[OK] Android build completed successfully"

      - name: Verify build artifacts
        run: |
          echo "Verifying build artifacts..."
          
          APK_PATH="example/android/app/build/outputs/apk/debug/app-debug.apk"
          
          if [ -f "$APK_PATH" ]; then
            echo "[OK] APK found: $APK_PATH"
            
            # Get APK size
            APK_SIZE=$(stat -f%z "$APK_PATH" 2>/dev/null || stat -c%s "$APK_PATH")
            APK_SIZE_MB=$((APK_SIZE / 1024 / 1024))
            echo "  APK size: ${APK_SIZE_MB}MB"
            
            # Check if APK contains native libraries (optional verification)
            if command -v unzip &> /dev/null; then
              echo ""
              echo "Checking APK contents for native libraries:"
              unzip -l "$APK_PATH" | grep -E "lib/.*\.so" | head -10 || echo "No native libraries found in APK listing"
            fi
          else
            echo "[ERROR] APK not found at expected path: $APK_PATH"
            echo "Available files in build directory:"
            find example/android/app/build -name "*.apk" -type f 2>/dev/null || echo "No APK files found"
            exit 1
          fi
          
          # Also check for AAR if building library
          AAR_PATH="android/build/outputs/aar/android-release.aar"
          if [ -f "$AAR_PATH" ]; then
            echo "[OK] AAR found: $AAR_PATH"
          fi
