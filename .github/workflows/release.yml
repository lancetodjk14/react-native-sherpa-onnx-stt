name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  trigger-builds:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
      checks: read
    outputs:
      ios_run_id: ${{ steps.find-runs.outputs.ios_run_id }}
      android_run_id: ${{ steps.find-runs.outputs.android_run_id }}

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Extract tag name
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Tag name: $TAG_NAME"

      - name: Trigger iOS workflow
        uses: actions/github-script@v7
        with:
          script: |
            const response = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ios.yml',
              ref: '${{ github.ref }}'
            });
            console.log('Triggered iOS workflow');

      - name: Trigger Android workflow
        uses: actions/github-script@v7
        with:
          script: |
            const response = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'android.yml',
              ref: '${{ github.ref }}'
            });
            console.log('Triggered Android workflow');

      - name: Wait for iOS and Android workflows to complete
        id: wait-workflows
        uses: actions/github-script@v7
        with:
          script: |
            const maxWaitTime = 60 * 60 * 1000; // 60 minutes
            const checkInterval = 30 * 1000; // 30 seconds
            const startTime = Date.now();

            let iosRunId = null;
            let androidRunId = null;

            console.log('Waiting for iOS and Android workflows to complete...');

            while (Date.now() - startTime < maxWaitTime) {
              // Check iOS workflow
              if (!iosRunId) {
                const iosRuns = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: 'ios.yml',
                  ref: '${{ github.ref }}',
                  per_page: 5
                });
                
                // Find the most recent run that was triggered after we started
                const recentIosRun = iosRuns.data.workflow_runs.find(run => 
                  new Date(run.created_at) >= new Date(startTime - 60000) // 1 minute buffer
                );
                
                if (recentIosRun) {
                  if (recentIosRun.status === 'completed') {
                    if (recentIosRun.conclusion === 'success') {
                      iosRunId = recentIosRun.id;
                      console.log(`✓ iOS workflow completed successfully: ${iosRunId}`);
                    } else {
                      throw new Error(`iOS workflow failed with conclusion: ${recentIosRun.conclusion}`);
                    }
                  } else {
                    console.log(`iOS workflow status: ${recentIosRun.status} (run ${recentIosRun.id})`);
                  }
                }
              }
              
              // Check Android workflow
              if (!androidRunId) {
                const androidRuns = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: 'android.yml',
                  ref: '${{ github.ref }}',
                  per_page: 5
                });
                
                // Find the most recent run that was triggered after we started
                const recentAndroidRun = androidRuns.data.workflow_runs.find(run => 
                  new Date(run.created_at) >= new Date(startTime - 60000) // 1 minute buffer
                );
                
                if (recentAndroidRun) {
                  if (recentAndroidRun.status === 'completed') {
                    if (recentAndroidRun.conclusion === 'success') {
                      androidRunId = recentAndroidRun.id;
                      console.log(`✓ Android workflow completed successfully: ${androidRunId}`);
                    } else {
                      throw new Error(`Android workflow failed with conclusion: ${recentAndroidRun.conclusion}`);
                    }
                  } else {
                    console.log(`Android workflow status: ${recentAndroidRun.status} (run ${recentAndroidRun.id})`);
                  }
                }
              }
              
              // If both workflows are complete, break
              if (iosRunId && androidRunId) {
                break;
              }
              
              // Wait before next check
              await new Promise(resolve => setTimeout(resolve, checkInterval));
            }

            if (!iosRunId) {
              throw new Error('iOS workflow did not complete within timeout period');
            }

            if (!androidRunId) {
              throw new Error('Android workflow did not complete within timeout period');
            }

            core.setOutput('ios_run_id', iosRunId);
            core.setOutput('android_run_id', androidRunId);
            console.log(`\n✓ Both workflows completed successfully!`);
            console.log(`  iOS run ID: ${iosRunId}`);
            console.log(`  Android run ID: ${androidRunId}`);

      # DISABLED: For debugging purposes - use existing workflow runs instead of waiting
      # Set if: false to true and comment out the "Wait for iOS and Android workflows to complete", "Trigger iOS workflow" and "Trigger Android workflow" steps
      # to use artifacts from workflows that already ran with this tag
      - name: Find existing iOS and Android workflow runs
        id: find-existing-runs
        if: false
        uses: actions/github-script@v7
        with:
          script: |
            console.log('Finding existing workflow runs for tag: ${{ github.ref }}');

            // Find iOS workflow run
            const iosRuns = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ios.yml',
              ref: '${{ github.ref }}',
              per_page: 10
            });

            const completedIosRun = iosRuns.data.workflow_runs.find(run => 
              run.status === 'completed' && run.conclusion === 'success'
            );

            if (!completedIosRun) {
              throw new Error('No completed iOS workflow run found for this tag');
            }

            console.log(`✓ Found iOS workflow run: ${completedIosRun.id} (${completedIosRun.created_at})`);

            // Find Android workflow run
            const androidRuns = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'android.yml',
              ref: '${{ github.ref }}',
              per_page: 10
            });

            const completedAndroidRun = androidRuns.data.workflow_runs.find(run => 
              run.status === 'completed' && run.conclusion === 'success'
            );

            if (!completedAndroidRun) {
              throw new Error('No completed Android workflow run found for this tag');
            }

            console.log(`✓ Found Android workflow run: ${completedAndroidRun.id} (${completedAndroidRun.created_at})`);

            core.setOutput('ios_run_id', completedIosRun.id);
            core.setOutput('android_run_id', completedAndroidRun.id);
            console.log(`\n✓ Using existing workflow runs:`);
            console.log(`  iOS run ID: ${completedIosRun.id}`);
            console.log(`  Android run ID: ${completedAndroidRun.id}`);

      - name: Output workflow run IDs
        id: find-runs
        run: |
          echo "ios_run_id=${{ steps.wait-workflows.outputs.ios_run_id }}" >> $GITHUB_OUTPUT
          echo "android_run_id=${{ steps.wait-workflows.outputs.android_run_id }}" >> $GITHUB_OUTPUT

  create-release:
    runs-on: ubuntu-latest
    needs: trigger-builds
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Extract tag name
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Tag name: $TAG_NAME"

      - name: List available artifacts for iOS run
        uses: actions/github-script@v7
        with:
          script: |
            const iosRunId = '${{ needs.trigger-builds.outputs.ios_run_id }}';
            const expectedTag = '${{ github.ref }}';
            const expectedTagName = expectedTag.replace('refs/tags/', '');

            console.log(`Checking artifacts for iOS run ID: ${iosRunId}`);
            console.log(`Expected tag: ${expectedTagName} (${expectedTag})`);

            // Get workflow run details to validate it matches the tag
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: parseInt(iosRunId)
            });

            console.log(`\nWorkflow run details:`);
            console.log(`  - Head branch/ref: ${run.data.head_branch || run.data.head_repository?.default_branch || 'N/A'}`);
            console.log(`  - Head SHA: ${run.data.head_sha}`);
            console.log(`  - Status: ${run.data.status}, Conclusion: ${run.data.conclusion}`);
            console.log(`  - Created: ${run.data.created_at}`);

            // Validate that the run is for the correct tag
            // Note: head_branch might be null for tag-triggered runs, so we check head_sha matches
            const currentSha = '${{ github.sha }}';
            if (run.data.head_sha !== currentSha) {
              console.warn(`⚠ Warning: Run head SHA (${run.data.head_sha}) does not match current SHA (${currentSha})`);
            } else {
              console.log(`✓ Run SHA matches current tag SHA`);
            }

            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: parseInt(iosRunId)
            });

            console.log(`\nFound ${artifacts.data.artifacts.length} artifact(s):`);
            artifacts.data.artifacts.forEach(a => {
              console.log(`  - Name: "${a.name}" (ID: ${a.id}, Size: ${a.size_in_bytes} bytes, Created: ${a.created_at})`);
            });

            const iosArtifact = artifacts.data.artifacts.find(a => a.name === 'ios-app-bundle');
            if (!iosArtifact) {
              console.error('ERROR: Artifact "ios-app-bundle" not found!');
              console.error('Available artifact names:', artifacts.data.artifacts.map(a => a.name).join(', '));
              throw new Error(`Artifact "ios-app-bundle" not found in run ${iosRunId} for tag ${expectedTagName}`);
            } else {
              console.log(`✓ Found ios-app-bundle artifact (ID: ${iosArtifact.id})`);
            }

      - name: Download iOS app bundle artifact
        uses: actions/download-artifact@v7
        with:
          name: ios-app-bundle
          run-id: ${{ needs.trigger-builds.outputs.ios_run_id }}
          path: artifacts/ios
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify iOS artifact
        run: |
          echo "Verifying iOS artifact..."
          if [ ! -d "artifacts/ios" ]; then
            echo "Error: artifacts/ios directory not found"
            exit 1
          fi

          echo "Contents of artifacts/ios:"
          find artifacts/ios -type f -name "*.ipa" || find artifacts/ios -type d -name "*.app" || ls -la artifacts/ios

          IPA_COUNT=$(find artifacts/ios -name "*.ipa" -type f | wc -l)
          if [ "$IPA_COUNT" -eq 0 ]; then
            echo "Warning: No IPA file found in artifacts/ios"
          else
            echo "Found $IPA_COUNT IPA file(s)"
          fi

      - name: List available artifacts for Android run
        uses: actions/github-script@v7
        with:
          script: |
            const androidRunId = '${{ needs.trigger-builds.outputs.android_run_id }}';
            const expectedTag = '${{ github.ref }}';
            const expectedTagName = expectedTag.replace('refs/tags/', '');

            console.log(`Checking artifacts for Android run ID: ${androidRunId}`);
            console.log(`Expected tag: ${expectedTagName} (${expectedTag})`);

            // Get workflow run details to validate it matches the tag
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: parseInt(androidRunId)
            });

            console.log(`\nWorkflow run details:`);
            console.log(`  - Head branch/ref: ${run.data.head_branch || run.data.head_repository?.default_branch || 'N/A'}`);
            console.log(`  - Head SHA: ${run.data.head_sha}`);
            console.log(`  - Status: ${run.data.status}, Conclusion: ${run.data.conclusion}`);
            console.log(`  - Created: ${run.data.created_at}`);

            // Validate that the run is for the correct tag
            const currentSha = '${{ github.sha }}';
            if (run.data.head_sha !== currentSha) {
              console.warn(`⚠ Warning: Run head SHA (${run.data.head_sha}) does not match current SHA (${currentSha})`);
            } else {
              console.log(`✓ Run SHA matches current tag SHA`);
            }

            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: parseInt(androidRunId)
            });

            console.log(`\nFound ${artifacts.data.artifacts.length} artifact(s):`);
            artifacts.data.artifacts.forEach(a => {
              console.log(`  - Name: "${a.name}" (ID: ${a.id}, Size: ${a.size_in_bytes} bytes, Created: ${a.created_at})`);
            });

            const androidArtifact = artifacts.data.artifacts.find(a => a.name === 'android-debug-apk');
            if (!androidArtifact) {
              console.error('ERROR: Artifact "android-debug-apk" not found!');
              console.error('Available artifact names:', artifacts.data.artifacts.map(a => a.name).join(', '));
              throw new Error(`Artifact "android-debug-apk" not found in run ${androidRunId} for tag ${expectedTagName}`);
            } else {
              console.log(`✓ Found android-debug-apk artifact (ID: ${androidArtifact.id})`);
            }

      - name: Download Android APK artifact
        uses: actions/download-artifact@v7
        with:
          name: android-debug-apk
          run-id: ${{ needs.trigger-builds.outputs.android_run_id }}
          path: artifacts/android
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify and organize Android artifact
        run: |
          echo "Verifying Android artifact..."
          if [ ! -d "artifacts/android" ]; then
            echo "Error: artifacts/android directory not found"
            exit 1
          fi

          cd artifacts/android

          echo "Contents of artifacts/android:"
          ls -la || echo "Directory is empty"

          # The APK might be in a subdirectory, find and move it to root if needed
          if [ -f "app-debug.apk" ]; then
            echo "Found APK at root"
          else
            echo "Searching for APK files..."
            find . -name "*.apk" -type f
            
            # Try to find and copy the APK to root
            APK_FILE=$(find . -name "*.apk" -type f | head -1)
            if [ -n "$APK_FILE" ]; then
              # Get just the filename
              APK_NAME=$(basename "$APK_FILE")
              if [ "$APK_NAME" != "app-debug.apk" ]; then
                cp "$APK_FILE" app-debug.apk
                echo "Copied APK: $APK_FILE -> app-debug.apk"
              fi
            else
              echo "Warning: No APK file found in artifacts/android"
            fi
          fi

          APK_COUNT=$(find . -name "*.apk" -type f | wc -l)
          echo "Found $APK_COUNT APK file(s)"
          cd ../..

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          # Find and copy iOS IPA file (already a valid .ipa archive)
          IPA_FILE=$(find artifacts/ios -name "*.ipa" -type f | head -1)
          if [ -n "$IPA_FILE" ]; then
            cp "$IPA_FILE" release-assets/SherpaOnnxSttExample.ipa
            echo "[OK] iOS IPA copied from: $IPA_FILE"
          else
            echo "Warning: iOS IPA file not found in artifacts"
            echo "Contents of artifacts/ios:"
            find artifacts/ios -type f || echo "No files found"
          fi

          # Copy Android APK (check multiple possible locations)
          ANDROID_APK=$(find artifacts/android -name "*.apk" -type f | head -1)
          if [ -n "$ANDROID_APK" ]; then
            cp "$ANDROID_APK" release-assets/SherpaOnnxSttExample-android-debug.apk
            echo "[OK] Android APK copied from: $ANDROID_APK"
          else
            echo "Warning: Android APK not found in artifacts"
            echo "Contents of artifacts/android:"
            find artifacts/android -type f || echo "No files found"
          fi

          # List release assets
          echo ""
          echo "Release assets prepared:"
          ls -lh release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: Release ${{ steps.tag.outputs.tag_name }}
          body: |
            ## Release ${{ steps.tag.outputs.tag_name }}

            ### iOS
            - **IPA**: `SherpaOnnxSttExample.ipa`

            ### Android
            - **Debug APK**: `SherpaOnnxSttExample-android-debug.apk`

            ---

            Built from commit: ${{ github.sha }}
          files: |
            release-assets/*.ipa
            release-assets/*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
