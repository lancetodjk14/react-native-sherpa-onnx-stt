name: Create Release

on:
  push:

jobs:
  trigger-builds:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    outputs:
      ios_run_id: ${{ steps.find-runs.outputs.ios_run_id }}
      android_run_id: ${{ steps.find-runs.outputs.android_run_id }}

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Extract tag name
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Tag name: $TAG_NAME"

      - name: Trigger iOS workflow
        uses: actions/github-script@v7
        with:
          script: |
            const response = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ios.yml',
              ref: '${{ github.ref }}'
            });
            console.log('Triggered iOS workflow');

      - name: Trigger Android workflow
        uses: actions/github-script@v7
        with:
          script: |
            const response = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'android.yml',
              ref: '${{ github.ref }}'
            });
            console.log('Triggered Android workflow');

      - name: Wait for iOS workflow to complete
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.ref }}
          check-name: 'build-ios'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
          allowed-conclusions: success

      - name: Wait for Android workflow to complete
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.ref }}
          check-name: 'build-android'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
          allowed-conclusions: success

      - name: Find iOS workflow run
        id: ios-run
        uses: actions/github-script@v7
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ios.yml',
              ref: '${{ github.ref }}',
              status: 'success',
              per_page: 1
            });
            
            if (runs.data.workflow_runs.length === 0) {
              throw new Error('No successful iOS workflow run found');
            }
            
            const runId = runs.data.workflow_runs[0].id;
            core.setOutput('run_id', runId);
            console.log(`Found iOS workflow run: ${runId}`);

      - name: Find Android workflow run
        id: android-run
        uses: actions/github-script@v7
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'android.yml',
              ref: '${{ github.ref }}',
              status: 'success',
              per_page: 1
            });
            
            if (runs.data.workflow_runs.length === 0) {
              throw new Error('No successful Android workflow run found');
            }
            
            const runId = runs.data.workflow_runs[0].id;
            core.setOutput('run_id', runId);
            console.log(`Found Android workflow run: ${runId}`);

      - name: Output workflow run IDs
        id: find-runs
        run: |
          echo "iOS workflow run ID: ${{ steps.ios-run.outputs.run_id }}"
          echo "Android workflow run ID: ${{ steps.android-run.outputs.run_id }}"
          echo "ios_run_id=${{ steps.ios-run.outputs.run_id }}" >> $GITHUB_OUTPUT
          echo "android_run_id=${{ steps.android-run.outputs.run_id }}" >> $GITHUB_OUTPUT

  create-release:
    runs-on: ubuntu-latest
    needs: trigger-builds
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Extract tag name
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Tag name: $TAG_NAME"

      - name: Download iOS app bundle artifact
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const iosRunId = '${{ needs.trigger-builds.outputs.ios_run_id }}';
            
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: parseInt(iosRunId)
            });
            
            const iosArtifact = artifacts.data.artifacts.find(a => a.name === 'ios-app-bundle');
            if (!iosArtifact) {
              throw new Error('iOS app bundle artifact not found');
            }
            
            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: iosArtifact.id,
              archive_format: 'zip'
            });
            
            const artifactPath = 'artifacts/ios';
            fs.mkdirSync(artifactPath, { recursive: true });
            fs.writeFileSync(path.join(artifactPath, 'artifact.zip'), Buffer.from(download.data));
            
            console.log(`Downloaded iOS artifact: ${iosArtifact.name}`);

      - name: Extract iOS artifact
        run: |
          cd artifacts/ios
          unzip -q artifact.zip
          rm artifact.zip
          cd ../..

      - name: Download Android APK artifact
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const androidRunId = '${{ needs.trigger-builds.outputs.android_run_id }}';
            
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: parseInt(androidRunId)
            });
            
            const androidArtifact = artifacts.data.artifacts.find(a => a.name === 'android-debug-apk');
            if (!androidArtifact) {
              throw new Error('Android APK artifact not found');
            }
            
            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: androidArtifact.id,
              archive_format: 'zip'
            });
            
            const artifactPath = 'artifacts/android';
            fs.mkdirSync(artifactPath, { recursive: true });
            fs.writeFileSync(path.join(artifactPath, 'artifact.zip'), Buffer.from(download.data));
            
            console.log(`Downloaded Android artifact: ${androidArtifact.name}`);

      - name: Extract Android artifact
        run: |
          cd artifacts/android
          unzip -q artifact.zip -d .
          # The APK might be in a subdirectory, find and move it
          if [ -f "app-debug.apk" ]; then
            echo "Found APK at root"
          elif [ -f "*/app-debug.apk" ]; then
            mv */app-debug.apk app-debug.apk
            echo "Moved APK to root"
          else
            echo "APK structure:"
            find . -name "*.apk" -type f
            # Try to find and copy the APK
            APK_FILE=$(find . -name "*.apk" -type f | head -1)
            if [ -n "$APK_FILE" ]; then
              cp "$APK_FILE" app-debug.apk
              echo "Copied APK: $APK_FILE"
            fi
          fi
          rm -f artifact.zip
          cd ../..

      - name: Extract iOS artifact
        run: |
          cd artifacts/ios
          unzip -q artifact.zip
          rm artifact.zip
          cd ../..

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          
          # Find and copy iOS IPA file (already a valid .ipa archive)
          IPA_FILE=$(find artifacts/ios -name "*.ipa" -type f | head -1)
          if [ -n "$IPA_FILE" ]; then
            cp "$IPA_FILE" release-assets/SherpaOnnxSttExample.ipa
            echo "[OK] iOS IPA copied from: $IPA_FILE"
          else
            echo "Warning: iOS IPA file not found in artifacts"
            echo "Contents of artifacts/ios:"
            find artifacts/ios -type f || echo "No files found"
          fi
          
          # Copy Android APK (check multiple possible locations)
          ANDROID_APK=$(find artifacts/android -name "*.apk" -type f | head -1)
          if [ -n "$ANDROID_APK" ]; then
            cp "$ANDROID_APK" release-assets/SherpaOnnxSttExample-android-debug.apk
            echo "[OK] Android APK copied from: $ANDROID_APK"
          else
            echo "Warning: Android APK not found in artifacts"
            echo "Contents of artifacts/android:"
            find artifacts/android -type f || echo "No files found"
          fi
          
          # List release assets
          echo ""
          echo "Release assets prepared:"
          ls -lh release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: Release ${{ steps.tag.outputs.tag_name }}
          body: |
            ## Release ${{ steps.tag.outputs.tag_name }}
            
            ### iOS
            - **IPA**: `SherpaOnnxSttExample.ipa`
            
            ### Android
            - **Debug APK**: `SherpaOnnxSttExample-android-debug.apk`
            
            ---
            
            Built from commit: ${{ github.sha }}
          files: |
            release-assets/*.ipa
            release-assets/*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
