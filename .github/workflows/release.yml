name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  trigger-builds:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
      checks: read
    outputs:
      ios_run_id: ${{ steps.find-runs.outputs.ios_run_id }}
      android_run_id: ${{ steps.find-runs.outputs.android_run_id }}

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Extract tag name
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Tag name: $TAG_NAME"

      # TEMPORARILY DISABLED: Using existing artifacts from workflows that already ran with this tag
      # - name: Trigger iOS workflow
      #   uses: actions/github-script@v7
      #   with:
      #     script: |
      #       const response = await github.rest.actions.createWorkflowDispatch({
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         workflow_id: 'ios.yml',
      #         ref: '${{ github.ref }}'
      #       });
      #       console.log('Triggered iOS workflow');

      # - name: Trigger Android workflow
      #   uses: actions/github-script@v7
      #   with:
      #     script: |
      #       const response = await github.rest.actions.createWorkflowDispatch({
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         workflow_id: 'android.yml',
      #         ref: '${{ github.ref }}'
      #       });
      #       console.log('Triggered Android workflow');

      # TEMPORARILY DISABLED: Find existing workflow runs instead of waiting
      - name: Find existing iOS and Android workflow runs
        id: find-existing-runs
        uses: actions/github-script@v7
        with:
          script: |
            console.log('Finding existing workflow runs for tag: ${{ github.ref }}');
            
            // Find iOS workflow run
            const iosRuns = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ios.yml',
              ref: '${{ github.ref }}',
              per_page: 10
            });
            
            const completedIosRun = iosRuns.data.workflow_runs.find(run => 
              run.status === 'completed' && run.conclusion === 'success'
            );
            
            if (!completedIosRun) {
              throw new Error('No completed iOS workflow run found for this tag');
            }
            
            console.log(`✓ Found iOS workflow run: ${completedIosRun.id} (${completedIosRun.created_at})`);
            
            // Find Android workflow run
            const androidRuns = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'android.yml',
              ref: '${{ github.ref }}',
              per_page: 10
            });
            
            const completedAndroidRun = androidRuns.data.workflow_runs.find(run => 
              run.status === 'completed' && run.conclusion === 'success'
            );
            
            if (!completedAndroidRun) {
              throw new Error('No completed Android workflow run found for this tag');
            }
            
            console.log(`✓ Found Android workflow run: ${completedAndroidRun.id} (${completedAndroidRun.created_at})`);
            
            core.setOutput('ios_run_id', completedIosRun.id);
            core.setOutput('android_run_id', completedAndroidRun.id);
            console.log(`\n✓ Using existing workflow runs:`);
            console.log(`  iOS run ID: ${completedIosRun.id}`);
            console.log(`  Android run ID: ${completedAndroidRun.id}`);

      - name: Output workflow run IDs
        id: find-runs
        run: |
          echo "ios_run_id=${{ steps.find-existing-runs.outputs.ios_run_id }}" >> $GITHUB_OUTPUT
          echo "android_run_id=${{ steps.find-existing-runs.outputs.android_run_id }}" >> $GITHUB_OUTPUT

  create-release:
    runs-on: ubuntu-latest
    needs: trigger-builds
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Extract tag name
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Tag name: $TAG_NAME"

      - name: Download iOS app bundle artifact
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const iosRunId = '${{ needs.trigger-builds.outputs.ios_run_id }}';
            
            console.log(`Looking for iOS workflow run: ${iosRunId}`);
            
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: parseInt(iosRunId)
            });
            
            console.log(`Found ${artifacts.data.artifacts.length} artifacts`);
            artifacts.data.artifacts.forEach(a => {
              console.log(`  - ${a.name} (${a.size_in_bytes} bytes)`);
            });
            
            const iosArtifact = artifacts.data.artifacts.find(a => a.name === 'ios-app-bundle');
            if (!iosArtifact) {
              throw new Error('iOS app bundle artifact not found');
            }
            
            console.log(`Downloading artifact: ${iosArtifact.name} (ID: ${iosArtifact.id})`);
            
            // Get download URL - this returns a redirect URL
            const downloadResponse = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: iosArtifact.id,
              archive_format: 'zip'
            });
            
            // Follow the redirect and download
            const downloadUrl = downloadResponse.url || downloadResponse.data?.url;
            if (!downloadUrl) {
              throw new Error('No download URL returned from API');
            }
            
            console.log(`Download URL: ${downloadUrl}`);
            
            const fetch = (await import('node-fetch')).default;
            const response = await fetch(downloadUrl, {
              headers: {
                'Authorization': `token ${process.env.GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github+json'
              }
            });
            
            if (!response.ok) {
              throw new Error(`Failed to download artifact: ${response.status} ${response.statusText}`);
            }
            
            const arrayBuffer = await response.arrayBuffer();
            const buffer = Buffer.from(arrayBuffer);
            
            const artifactPath = 'artifacts/ios';
            fs.mkdirSync(artifactPath, { recursive: true });
            const zipPath = path.join(artifactPath, 'artifact.zip');
            fs.writeFileSync(zipPath, buffer);
            
            const stats = fs.statSync(zipPath);
            console.log(`Downloaded iOS artifact: ${iosArtifact.name} (${stats.size} bytes)`);

      - name: Extract iOS artifact
        run: |
          echo "Extracting iOS artifact..."
          cd artifacts/ios
          
          if [ ! -f "artifact.zip" ]; then
            echo "Error: artifact.zip not found in artifacts/ios"
            echo "Current directory: $(pwd)"
            echo "Contents of artifacts/ios:"
            ls -la || echo "Directory is empty"
            exit 1
          fi
          
          echo "Found artifact.zip ($(stat -f%z artifact.zip 2>/dev/null || stat -c%s artifact.zip) bytes), extracting..."
          unzip -q artifact.zip
          
          echo "Extraction complete. Contents:"
          find . -type f -name "*.ipa" || find . -type d -name "*.app" || ls -la
          
          rm artifact.zip
          cd ../..

      - name: Download Android APK artifact
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const androidRunId = '${{ needs.trigger-builds.outputs.android_run_id }}';
            
            console.log(`Looking for Android workflow run: ${androidRunId}`);
            
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: parseInt(androidRunId)
            });
            
            console.log(`Found ${artifacts.data.artifacts.length} artifacts`);
            artifacts.data.artifacts.forEach(a => {
              console.log(`  - ${a.name} (${a.size_in_bytes} bytes)`);
            });
            
            const androidArtifact = artifacts.data.artifacts.find(a => a.name === 'android-debug-apk');
            if (!androidArtifact) {
              throw new Error('Android APK artifact not found');
            }
            
            console.log(`Downloading artifact: ${androidArtifact.name} (ID: ${androidArtifact.id})`);
            
            // Get download URL - this returns a redirect URL
            const downloadResponse = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: androidArtifact.id,
              archive_format: 'zip'
            });
            
            // Follow the redirect and download
            const downloadUrl = downloadResponse.url || downloadResponse.data?.url;
            if (!downloadUrl) {
              throw new Error('No download URL returned from API');
            }
            
            console.log(`Download URL: ${downloadUrl}`);
            
            const fetch = (await import('node-fetch')).default;
            const response = await fetch(downloadUrl, {
              headers: {
                'Authorization': `token ${process.env.GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github+json'
              }
            });
            
            if (!response.ok) {
              throw new Error(`Failed to download artifact: ${response.status} ${response.statusText}`);
            }
            
            const arrayBuffer = await response.arrayBuffer();
            const buffer = Buffer.from(arrayBuffer);
            
            const artifactPath = 'artifacts/android';
            fs.mkdirSync(artifactPath, { recursive: true });
            const zipPath = path.join(artifactPath, 'artifact.zip');
            fs.writeFileSync(zipPath, buffer);
            
            const stats = fs.statSync(zipPath);
            console.log(`Downloaded Android artifact: ${androidArtifact.name} (${stats.size} bytes)`);

      - name: Extract Android artifact
        run: |
          echo "Extracting Android artifact..."
          cd artifacts/android
          
          if [ ! -f "artifact.zip" ]; then
            echo "Error: artifact.zip not found in artifacts/android"
            echo "Current directory: $(pwd)"
            echo "Contents of artifacts/android:"
            ls -la || echo "Directory is empty"
            exit 1
          fi
          
          echo "Found artifact.zip ($(stat -f%z artifact.zip 2>/dev/null || stat -c%s artifact.zip) bytes), extracting..."
          unzip -q artifact.zip -d .
          
          # The APK might be in a subdirectory, find and move it
          if [ -f "app-debug.apk" ]; then
            echo "Found APK at root"
          elif [ -f "*/app-debug.apk" ]; then
            mv */app-debug.apk app-debug.apk
            echo "Moved APK to root"
          else
            echo "APK structure:"
            find . -name "*.apk" -type f
            # Try to find and copy the APK
            APK_FILE=$(find . -name "*.apk" -type f | head -1)
            if [ -n "$APK_FILE" ]; then
              cp "$APK_FILE" app-debug.apk
              echo "Copied APK: $APK_FILE"
            fi
          fi
          
          rm -f artifact.zip
          cd ../..

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          
          # Find and copy iOS IPA file (already a valid .ipa archive)
          IPA_FILE=$(find artifacts/ios -name "*.ipa" -type f | head -1)
          if [ -n "$IPA_FILE" ]; then
            cp "$IPA_FILE" release-assets/SherpaOnnxSttExample.ipa
            echo "[OK] iOS IPA copied from: $IPA_FILE"
          else
            echo "Warning: iOS IPA file not found in artifacts"
            echo "Contents of artifacts/ios:"
            find artifacts/ios -type f || echo "No files found"
          fi
          
          # Copy Android APK (check multiple possible locations)
          ANDROID_APK=$(find artifacts/android -name "*.apk" -type f | head -1)
          if [ -n "$ANDROID_APK" ]; then
            cp "$ANDROID_APK" release-assets/SherpaOnnxSttExample-android-debug.apk
            echo "[OK] Android APK copied from: $ANDROID_APK"
          else
            echo "Warning: Android APK not found in artifacts"
            echo "Contents of artifacts/android:"
            find artifacts/android -type f || echo "No files found"
          fi
          
          # List release assets
          echo ""
          echo "Release assets prepared:"
          ls -lh release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: Release ${{ steps.tag.outputs.tag_name }}
          body: |
            ## Release ${{ steps.tag.outputs.tag_name }}
            
            ### iOS
            - **IPA**: `SherpaOnnxSttExample.ipa`
            
            ### Android
            - **Debug APK**: `SherpaOnnxSttExample-android-debug.apk`
            
            ---
            
            Built from commit: ${{ github.sha }}
          files: |
            release-assets/*.ipa
            release-assets/*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
